---
phase: 07-bottom-sheet-session
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: [seed/Screens/SessionSetupSheet.swift, seed/Domain/Models/AppSettings.swift]
autonomous: true

must_haves:
  truths:
    - "App remembers last used WPM across launches"
    - "WPM selector defaults to last used value"
    - "Start button navigates to RSVP session with text and WPM"
  artifacts:
    - path: "seed/Domain/Models/AppSettings.swift"
      provides: "WPM persistence with @AppStorage"
      contains: "@AppStorage(\"wpm\")"
    - path: "seed/Screens/SessionSetupSheet.swift"
      provides: "Start button with session navigation"
      contains: "Button.*Start"
  key_links:
    - from: "SessionSetupSheet wpm @State"
      to: "AppSettings.wpm"
      via: "init loads from AppSettings, button tap saves"
      pattern: "settings\\.wpm"
---

<objective>
Wire session start flow with WPM persistence and navigation to RSVP.

Purpose: Complete session setup UX (remember WPM, start session)
Output: Persistent WPM, start button navigates to RSVP with text + speed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-bottom-sheet-session/07-01-SUMMARY.md

**Requirements coverage:**
- SESS-08: App remembers last used WPM as default
- SESS-09: Large "start" button begins session

**Current AppSettings:**
- Has @AppStorage for fontSize, colorScheme, focusMode
- Pattern: @AppStorage property wrapper for persistence

**Note:** Full RSVP session wiring deferred to Phase 8 (new anchor visualization). For now, start button closes sheet and prints navigation intent.
</context>

<tasks>

<task type="auto">
  <name>Add WPM persistence to AppSettings</name>
  <files>seed/Domain/Models/AppSettings.swift</files>
  <action>
    Add after line 13 (after hasCompletedOnboarding):
    ```swift
    @ObservationIgnored @AppStorage("lastUsedWPM") var lastUsedWPM: Int = 250
    ```

    Default 250 WPM per v1.0 pattern (medium speed)

    Per SESS-08: App remembers last WPM across launches
  </action>
  <verify>xcodebuild compiles, AppSettings has lastUsedWPM property</verify>
  <done>AppSettings persists WPM with @AppStorage</done>
</task>

<task type="auto">
  <name>Wire SessionSetupSheet to use persisted WPM</name>
  <files>seed/Screens/SessionSetupSheet.swift</files>
  <action>
    1. Add @Environment after line ~10:
       ```swift
       @Environment(\.settings) var settings: AppSettings
       ```
       Wait, AppSettings not in Environment. Simpler: pass as parameter.

    Revised:
    1. Add parameter after isPresented binding (line ~11):
       ```swift
       var settings: AppSettings
       ```

    2. Update @State wpm init to use settings (line ~15):
       ```swift
       @State private var wpm: Int
       ```

    3. Add init after body:
       ```swift
       init(inputMode: InputMode, isPresented: Binding<Bool>, settings: AppSettings) {
           self.inputMode = inputMode
           self._isPresented = isPresented
           self.settings = settings
           self._wpm = State(initialValue: settings.lastUsedWPM)
       }
       ```

    4. In HomeView.swift, update sheet call to pass settings:
       ```swift
       SessionSetupSheet(inputMode: mode, isPresented: $showSessionSheet, settings: settings)
       ```

    5. In HomeView, add @Environment after line 14:
       ```swift
       @Environment(\.modelContext) private var modelContext
       // Add this:
       var settings: AppSettings
       ```
       Wait, HomeView needs settings passed from ContentView.

    Simpler approach - use @AppStorage directly in SessionSetupSheet:
    1. Replace @State var wpm with:
       ```swift
       @AppStorage("lastUsedWPM") private var wpm: Int = 250
       ```

    2. Remove init complexity

    Per SESS-08: WPM loads from and saves to @AppStorage automatically
  </action>
  <verify>xcodebuild succeeds, WPM persists across sheet dismissals</verify>
  <done>SessionSetupSheet loads and saves WPM to @AppStorage</done>
</task>

<task type="auto">
  <name>Add Start button to SessionSetupSheet</name>
  <files>seed/Screens/SessionSetupSheet.swift</files>
  <action>
    1. Add large Start button at bottom of VStack before Spacer (after WPM selector):
       ```swift
       Button {
           startSession()
       } label: {
           HStack {
               Image(systemName: "play.fill")
                   .font(.title3)
               Text("Start Reading")
                   .font(.headline)
           }
           .frame(maxWidth: .infinity)
           .padding()
           .background(canStartSession ? Color.accentColor : Color.gray)
           .foregroundColor(.white)
           .cornerRadius(12)
       }
       .disabled(!canStartSession)
       .padding(.horizontal)
       ```

    2. Add validation computed property before body:
       ```swift
       private var canStartSession: Bool {
           switch inputMode {
           case .text:
               return !textInput.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty
           case .link:
               return !urlInput.isEmpty && urlInput.starts(with: "http")
           case .pdf:
               return selectedPDFURL != nil
           }
       }
       ```

    3. Add startSession method after body:
       ```swift
       private func startSession() {
           // Phase 8 will wire full RSVP navigation
           // For now: close sheet, print intent
           print("Starting session: mode=\(inputMode), wpm=\(wpm)")

           switch inputMode {
           case .text:
               print("Text length: \(textInput.count) chars")
           case .link:
               print("URL: \(urlInput)")
           case .pdf:
               if let url = selectedPDFURL {
                   print("PDF: \(url.lastPathComponent)")
               }
           }

           isPresented = false
       }
       ```

    Per SESS-09: Large start button begins session (Phase 8 will add RSVP navigation)
  </action>
  <verify>xcodebuild succeeds, Start button enabled when input valid</verify>
  <done>Start button validates input and closes sheet</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] xcodebuild -scheme seed build succeeds
- [ ] AppSettings has lastUsedWPM @AppStorage property
- [ ] SessionSetupSheet loads WPM from @AppStorage
- [ ] WPM changes persist across sheet open/close
- [ ] Start button enabled only when input valid
- [ ] Start button closes sheet and logs session intent
</verification>

<success_criteria>

- All tasks completed
- xcodebuild succeeds with no errors
- WPM persists with @AppStorage
- SessionSetupSheet defaults to last used WPM
- Start button validates input per mode
- Start button closes sheet (RSVP navigation in Phase 8)
- Requirements SESS-08 and SESS-09 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/07-bottom-sheet-session/07-02-SUMMARY.md`
</output>
